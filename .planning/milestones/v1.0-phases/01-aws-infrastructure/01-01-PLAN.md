---
phase: 01-aws-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - iam/ducklake-s3-reader-policy.json
  - scripts/setup_iam.sh
  - scripts/verify_s3_access.sql
autonomous: false
user_setup:
  - service: aws
    why: "IAM resources must be created with admin credentials"
    dashboard_config:
      - task: "Store generated access key in Keeper for analyst distribution"
        location: "Keeper password manager"

must_haves:
  truths:
    - "A customer-managed IAM policy named ducklake-s3-reader exists in the AWS account"
    - "An IAM group named ducklake-readers exists with the policy attached"
    - "An IAM user named ducklake-analyst exists in the ducklake-readers group"
    - "The data owner can query S3 via DuckDB credential_chain without hardcoded keys"
  artefacts:
    - path: "iam/ducklake-s3-reader-policy.json"
      provides: "IAM policy document restricting to S3 read on stevecrawshaw-bucket"
      contains: "s3:GetObject"
    - path: "scripts/setup_iam.sh"
      provides: "AWS CLI commands to create policy, group, user, and access key"
      contains: "aws iam create-policy"
    - path: "scripts/verify_s3_access.sql"
      provides: "DuckDB SQL to create credential_chain secret and verify S3 access"
      contains: "credential_chain"
  key_links:
    - from: "iam/ducklake-s3-reader-policy.json"
      to: "scripts/setup_iam.sh"
      via: "file:// reference in create-policy command"
      pattern: "file://.*ducklake-s3-reader-policy.json"
---

<objective>
Create the IAM policy, group, and user for analyst S3 read access, plus the DuckDB credential_chain verification script for the data owner.

Purpose: Establishes the AWS access layer that all subsequent phases depend on. Without this, analysts cannot read from S3 and the data owner cannot verify DuckDB-to-S3 connectivity.
Output: IAM policy JSON, setup shell script, DuckDB verification SQL.
</objective>

<execution_context>
@C:\Users\steve.crawshaw\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\steve.crawshaw\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-aws-infrastructure/01-CONTEXT.md
@.planning/phases/01-aws-infrastructure/01-RESEARCH.md
@aws_setup.r
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IAM policy JSON and setup script</name>
  <files>iam/ducklake-s3-reader-policy.json, scripts/setup_iam.sh</files>
  <action>
    Create `iam/ducklake-s3-reader-policy.json` with the customer-managed policy:
    - Two statements: one for bucket-level actions (`s3:ListBucket`, `s3:GetBucketLocation`) on `arn:aws:s3:::stevecrawshaw-bucket`, one for object-level actions (`s3:GetObject`) on `arn:aws:s3:::stevecrawshaw-bucket/*`.
    - Use `"Version": "2012-10-17"`.
    - Include `Sid` fields for clarity (`AllowListBucket`, `AllowGetObject`).

    Create `scripts/setup_iam.sh`:
    - Bash script with set -euo pipefail.
    - Step 1: Retrieve account ID via `aws sts get-caller-identity --query Account --output text`.
    - Step 2: `aws iam create-policy` referencing `file://iam/ducklake-s3-reader-policy.json` (use relative path from project root).
    - Step 3: `aws iam create-group --group-name ducklake-readers`.
    - Step 4: `aws iam attach-group-policy` using the constructed ARN (`arn:aws:iam::${ACCOUNT_ID}:policy/ducklake-s3-reader`).
    - Step 5: `aws iam create-user --user-name ducklake-analyst`.
    - Step 6: `aws iam add-user-to-group`.
    - Step 7: `aws iam create-access-key --user-name ducklake-analyst` with a clear message to save the output.
    - Add comments throughout explaining each step.
    - Add an echo at the end reminding the user to store the access key in Keeper.
    - The script must be idempotent-aware: include comments noting that re-running will fail if resources already exist (this is expected, not an error to handle).
  </action>
  <verify>
    - `cat iam/ducklake-s3-reader-policy.json | python -m json.tool` validates as JSON.
    - `bash -n scripts/setup_iam.sh` passes syntax check.
    - Policy JSON contains both `s3:ListBucket` and `s3:GetObject` actions.
    - Policy JSON has separate Resource ARNs: bucket-level (no `/*`) and object-level (with `/*`).
  </verify>
  <done>
    IAM policy JSON file exists with correct S3 read-only permissions scoped to stevecrawshaw-bucket. Setup script exists with all 7 AWS CLI steps and clear comments.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Run IAM setup script</name>
  <action>
    Run the setup script from the project root directory:
    ```bash
    bash scripts/setup_iam.sh
    ```
  </action>
  <instructions>
    1. Open a terminal at the project root.
    2. Ensure you are authenticated with AWS admin credentials (the data owner's credentials, not the analyst credentials).
    3. Run `bash scripts/setup_iam.sh`.
    4. Save the access key output (AccessKeyId and SecretAccessKey) -- this is the only time the secret key is shown.
    5. Store both values in Keeper for analyst distribution.
    6. Type "done" when complete, or describe any errors.
  </instructions>
  <resume-signal>Type "done" or describe errors from the setup script</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create DuckDB credential_chain verification script</name>
  <files>scripts/verify_s3_access.sql</files>
  <action>
    Create `scripts/verify_s3_access.sql`:
    - First, install and load the aws extension: `INSTALL aws; LOAD aws;`
    - Create a secret using credential_chain: `CREATE OR REPLACE SECRET ducklake_s3 (TYPE s3, PROVIDER credential_chain, CHAIN config, REGION 'eu-west-2');`
    - Run a verification query: `SELECT * FROM glob('s3://stevecrawshaw-bucket/*');`
    - Add a second verification: `SELECT file_name FROM glob('s3://stevecrawshaw-bucket/pins/*') LIMIT 5;` (this will return empty initially, which is fine -- it confirms the prefix is queryable).
    - Add clear SQL comments explaining each step and what success looks like.
    - Include a comment noting that `CHAIN config` means DuckDB reads from `~/.aws/credentials`.
    - Include a comment about the explicit REGION override (pitfall from research: DuckDB does not always pick up region from config).
  </action>
  <verify>
    - File exists at `scripts/verify_s3_access.sql`.
    - File contains `credential_chain` and `REGION 'eu-west-2'`.
    - File contains `glob('s3://stevecrawshaw-bucket/` query.
  </verify>
  <done>
    DuckDB verification SQL exists that creates a credential_chain secret and lists bucket contents. Works for both data owner and analysts (same credential mechanism).
  </done>
</task>

</tasks>

<verification>
1. `iam/ducklake-s3-reader-policy.json` is valid JSON with correct S3 permissions.
2. `scripts/setup_iam.sh` contains all IAM creation steps and passes syntax check.
3. `scripts/verify_s3_access.sql` uses credential_chain with explicit region.
4. After human runs setup script: `aws iam get-policy --policy-arn arn:aws:iam::ACCOUNT_ID:policy/ducklake-s3-reader` returns the policy.
5. After human runs setup script: `aws iam list-groups-for-user --user-name ducklake-analyst` shows ducklake-readers group.
</verification>

<success_criteria>
- INFRA-01 partially met: IAM policy, group, and user exist (pending human execution of setup script).
- Data owner can run `verify_s3_access.sql` in DuckDB and see bucket contents listed.
- Access key has been generated and stored in Keeper.
</success_criteria>

<output>
After completion, create `.planning/phases/01-aws-infrastructure/01-01-SUMMARY.md`
</output>
